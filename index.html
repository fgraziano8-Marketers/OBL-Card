<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBL Taproom - Card Dipendenti Due Mari</title>
	<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-image: url('Background Landing Page.jpg');
			background-size: cover;
			background-position: center;
			background-repeat: no-repeat;
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Landing Page */
        .landing {
             text-align: center;
			 padding: 40px 20px;
			 background: rgba(0, 0, 0, 0.5);
			 border-radius: 15px;
        }

        .logo-container {
            width: 150px;
            height: 150px;
            margin: 0 auto 30px;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        h1 {
		font-family: 'Oswald', sans-serif;
            font-size: 2.5em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #EEA300);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #fff;
        }

        .benefit {
            background: rgba(238, 163, 0, 0.1);
            border: 2px solid #EEA300;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .benefit-title {
            font-size: 2em;
            color: #EEA300;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
            font-weight: 500;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #444;
            border-radius: 10px;
            background: #2d2d2d;
            color: #fff;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #EEA300;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 20px 0;
        }

        input[type="checkbox"] {
            margin-top: 4px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 0.9em;
            color: #ccc;
            line-height: 1.5;
        }

        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #EEA300);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(238, 163, 0, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Card Display */
        .card-container {
            background: #fff;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .card-header {
            color: #1a1a1a;
            margin-bottom: 20px;
        }

        .discount-card {
            background: linear-gradient(135deg, #255C87 0%, #1a4d6d 100%);
            border-radius: 15px;
            padding: 30px;
            color: #fff;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 3px solid #EEA300;
        }

        .discount-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(238, 163, 0, 0.15) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }

        .card-content {
            position: relative;
            z-index: 1;
        }

        .card-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .card-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-title {
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #EEA300;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .cardholder-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fff;
        }

        .discount-badge {
            display: inline-block;
            background: #EEA300;
            color: #1a1a1a;
            padding: 10px 30px;
            border-radius: 25px;
            font-size: 1.8em;
            font-weight: bold;
            margin: 15px 0;
        }

        .validity {
            font-size: 0.9em;
            color: #ddd;
            margin-top: 10px;
        }

        .qr-container {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            display: inline-block;
            margin: 20px 0;
            border: 3px solid #EEA300;
        }

        .card-id {
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
        }

        .download-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .download-buttons button {
            flex: 1;
        }

        /* Validation Interface */
        .validation-section {
            margin-top: 40px;
        }

        .scan-area {
            background: #2d2d2d;
            border: 3px dashed #EEA300;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
        }

        .scan-input {
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
            color: #fff;
            font-size: 18px;
            text-align: center;
            width: 100%;
            font-family: 'Courier New', monospace;
        }

        .scan-input:focus {
            outline: none;
            border-color: #EEA300;
        }

        .validation-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.1em;
        }

        .validation-success {
            background: rgba(52, 211, 153, 0.1);
            border: 2px solid #34d399;
            color: #34d399;
        }

        .validation-error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        .stats {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #255C87;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #ddd;
        }

        .stat-value {
            color: #EEA300;
            font-weight: bold;
        }

        .admin-toggle {
		position: relative;
		margin: 30px auto 0;
		max-width: 600px;
		background: transparent;
		border: 1px solid rgba(238, 163, 0, 0.3);
		border-radius: 8px;
		padding: 8px 15px;
		cursor: pointer;
		font-weight: normal;
		font-size: 12px;
		color: rgba(238, 163, 0, 0.5);
		z-index: 10;
		transition: all 0.3s;
		text-align: center;
}

.admin-toggle:hover {
    background: rgba(238, 163, 0, 0.1);
    color: #EEA300;
}
        }

        .admin-toggle:hover {
            background: #EEA300;
            color: #1a1a1a;
            transform: scale(1.05);
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success-message {
            background: rgba(52, 211, 153, 0.1);
            border: 2px solid #34d399;
            color: #34d399;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            
            .subtitle {
                font-size: 1.1em;
            }

            .logo-container {
                width: 120px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
<audio id="backgroundMusic">
    <source src="OBL_SOCIO.mp3" type="audio/mpeg">
</audio>
    <div class="container">
        <!-- Landing Page -->
        <div id="landingPage" class="landing">
            <div class="logo-container">
                <img src="Logo PNG.png" alt="OBL Craft Beer" id="mainLogo">
            </div>
            <h1>Lavori al Centro Commerciale Due Mari?</h1>
            <p class="subtitle">Dopo il turno vieni da noi, meriti una birra.</p>
            
            <div class="benefit">
                <div class="benefit-title">10% SU TUTTO, OGNI VOLTA CHE VUOI.</div>
                <p>Birra artigianale, smash burger e un posto in cui essere te stesso ‚Äî non un cliente.<br><br>
				<em>Se invece hai trovato questa pagina per caso‚Ä¶ beh, nessuno ti sta guardando.</em><br><br>
				Ci troviamo a meno di 1 km dal centro.</em><br> 
				<EM>Ti aspettiamo <strong>venerd√¨, sabato e domenica dalle 18:00 alle 24:00</strong>.
            </div>

            <form id="registrationForm">
                <div class="form-group">
                    <label for="name">Nome e Cognome *</label>
                    <input type="text" id="name" required placeholder="Mario Rossi">
                </div>

                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required placeholder="mario.rossi@email.com">
                </div>

                <div class="form-group">
                    <label for="phone">Telefono (opzionale)</label>
                    <input type="tel" id="phone" placeholder="+39 333 1234567">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="privacy" required>
                    <label for="privacy" class="checkbox-label">
                        Accetto la privacy policy e il trattamento dei dati personali *
                    </label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="marketing">
                    <label for="marketing" class="checkbox-label">
                        Voglio ricevere comunicazioni su eventi e novit√† della taproom
                    </label>
                </div>

                <div id="formError" class="error-message hidden"></div>

                <button type="submit" id="submitBtn">OTTIENI LA TUA CARD</button>
            </form>
            
            <!-- Admin Access Button -->
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="openAdmin()" style="background: transparent; border: 1px solid rgba(238, 163, 0, 0.3); font-size: 12px; padding: 8px 15px; color: rgba(238, 163, 0, 0.6);">
                    üîß Admin
                </button>
            </div>
        </div>

        <!-- Card Display (Hidden Initially) -->
        <div id="cardDisplay" class="card-container hidden">
            <div class="card-header">
                <h2>üç∫ Benvenuto nella famiglia OBL!</h2>
                <p>La tua card √® pronta</p>
            </div>

            <div class="discount-card">
                <div class="card-content">
                    <div class="card-logo">
                        <img src="Logo PNG.png" alt="OBL" id="cardLogo">
                    </div>
                    <div class="card-title">DIPENDENTI DUE MARI</div>
                    <div class="cardholder-name" id="cardholderName"></div>
                    <div class="discount-badge">-10%</div>
                    <div class="validity">Valido su tutte le consumazioni</div>
                    <div class="validity" id="cardValidity"></div>
                </div>
            </div>

            <div class="qr-container">
                <div id="qrcode"></div>
            </div>
            <div class="card-id" id="cardId"></div>

            <div style="margin: 30px 0; padding: 30px; background: linear-gradient(135deg, rgba(238, 163, 0, 0.1), rgba(37, 92, 135, 0.1)); border-radius: 15px; border: 2px solid #EEA300;">
                <h3 style="color: #EEA300; margin-bottom: 20px; font-size: 1.3em;">üéØ Cosa fare ora</h3>
                <p style="color: #1a1a1a; line-height: 1.8; font-size: 1.05em;">
                    ‚úì La card si sta scaricando automaticamente<br>
                    ‚úì Mostrala al banco per il <strong>10% di sconto</strong><br>
                    ‚úì Valida su <strong>tutte le consumazioni</strong><br>
                    ‚úì Fai parte della nostra <strong>community</strong>
                </p>
            </div>

            <div style="margin: 20px 0; padding: 25px; background: rgba(37, 92, 135, 0.1); border-radius: 15px;">
                <h3 style="color: #255C87; margin-bottom: 15px; font-size: 1.2em;">üìç Ci trovi qui</h3>
                <p style="color: #1a1a1a; font-size: 1em;">
                    <strong>A meno di 1 km dal Centro Commerciale Due Mari</strong><br><br>
                    üïí Venerd√¨ - Sabato - Domenica<br>
                    ‚è∞ Dalle 18:00 alle 24:00<br><br>
                    <span style="color: #EEA300; font-weight: bold; font-size: 1.1em;">Ti aspettiamo in taproom! üçª</span>
                </p>
            </div>

            <button onclick="window.location='index.html'" style="background: linear-gradient(135deg, #255C87, #1a4d6d); margin-top: 20px;">
                ‚Üê Torna alla Home
            </button>
        </div>

        <!-- Thank You Page rimossa, ora tutto √® in cardDisplay -->

        <!-- Admin Validation Section (Hidden Initially) -->
        <div id="adminSection" class="card-container hidden">
            <div class="card-header">
                <h2>üîß Admin - Validazione Card</h2>
                <p style="color: #666;">Scansiona o inserisci il codice della card</p>
            </div>

            <div style="background: #f5f5f5; border: 3px dashed #EEA300; border-radius: 15px; padding: 40px; text-align: center; margin: 20px 0;">
                <input type="text" 
                       id="adminScanInput" 
                       style="background: #fff; border: 2px solid #ddd; border-radius: 10px; padding: 15px; color: #1a1a1a; font-size: 18px; text-align: center; width: 100%; font-family: 'Courier New', monospace; margin-bottom: 15px;"
                       placeholder="Inserisci codice card..."
                       autofocus>
                <button onclick="validateCardAdmin()" style="background: linear-gradient(135deg, #EEA300, #255C87);">
                    ‚úì Valida Card
                </button>
            </div>

            <div id="adminValidationResult"></div>

            <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; margin-top: 20px; border: 2px solid #255C87;">
                <h3 style="margin-bottom: 15px; color: #1a1a1a;">Statistiche Campagna</h3>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd; color: #1a1a1a;">
                    <span>Card Generate:</span>
                    <strong style="color: #EEA300;" id="adminTotalCards">0</strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd; color: #1a1a1a;">
                    <span>Card Utilizzate:</span>
                    <strong style="color: #EEA300;" id="adminUsedCards">0</strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd; color: #1a1a1a;">
                    <span>Tasso di Conversione:</span>
                    <strong style="color: #EEA300;" id="adminConversionRate">0%</strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; color: #1a1a1a;">
                    <span>Registrazioni Oggi:</span>
                    <strong style="color: #EEA300;" id="adminTodayRegistrations">0</strong>
                </div>
            </div>

            <button onclick="downloadStatsAdmin()" style="margin-top: 20px; background: #2d2d2d;">
                üìä Scarica Report Completo
            </button>
            
            <button onclick="syncToGoogleSheets()" style="margin-top: 10px; background: #34d399; color: #1a1a1a;">
                üì§ Sincronizza con Google Sheets
            </button>

            <button onclick="window.location='index.html'" style="background: transparent; border: 2px solid #ddd; margin-top: 10px; color: #1a1a1a;">
                ‚Üê Torna alla Landing
            </button>
        </div>
    </div>
    <script>
        // ==================== CONFIGURAZIONE ====================
        const CAMPAIGN_START = new Date('2026-02-23T00:00:00');
        const ADMIN_PASSWORD = 'oblmicro';
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxxlflBXN5fCp6CRZzbysSvQDZS02s_LEc14sYBnjCNxPU_91n826BxN7q6OXNGcUtEAQ/exec';
        
        // EmailJS Configuration
		const EMAILJS_PUBLIC_KEY = '7BH3rsW8VzzHhxw1r';
		const EMAILJS_SERVICE_ID = 'service_iq43lhh';
		const EMAILJS_TEMPLATE_ID = 'template_wba27ge'
        
        // ==================== STORAGE MANAGEMENT ====================
        
        // Google Sheets as database
        const storage = {
            async set(key, value) {
                // Solo per 'cards' mandiamo a Google Sheets
                if (key === 'cards') {
                    const cards = JSON.parse(value);
                    const lastCard = cards[cards.length - 1];
                    
                    if (lastCard) {
                        try {
                            await fetch(GOOGLE_SHEETS_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    action: 'register',
                                    id: lastCard.id,
                                    name: lastCard.name,
                                    email: lastCard.email,
                                    phone: lastCard.phone || '',
                                    marketing: lastCard.marketing ? 'S√¨' : 'No',
                                    registrationDate: lastCard.registrationDate,
                                    expiryDate: lastCard.expiryDate,
                                    validityMonths: lastCard.validityMonths,
                                    used: lastCard.used ? 'S√¨' : 'No'
                                })
                            });
                        } catch (error) {
                            console.error('Google Sheets error:', error);
                        }
                    }
                }
                
                // Salva anche in localStorage per funzionalit√† offline
                localStorage.setItem(key, value);
                return { key, value, shared: false };
            },
            
            async get(key) {
                const value = localStorage.getItem(key);
                return value ? { key, value, shared: false } : null;
            },
            
            async delete(key) {
                localStorage.removeItem(key);
                return { key, deleted: true, shared: false };
            }
        };

        // Initialize storage
        async function initStorage() {
            try {
                const test = await storage.get('initialized');
                if (!test) {
                    await storage.set('initialized', 'true');
                    await storage.set('cards', JSON.stringify([]));
                    await storage.set('usage', JSON.stringify([]));
                }
            } catch (error) {
                console.error('Storage initialization error:', error);
            }
        }

        initStorage();

        // ==================== CARD VALIDITY LOGIC ====================
        
        function calculateValidity(registrationDate) {
            const daysSinceCampaignStart = Math.floor((registrationDate - CAMPAIGN_START) / (1000 * 60 * 60 * 24));
            
            let validityMonths;
            if (daysSinceCampaignStart <= 7) {
                validityMonths = 12;
            } else if (daysSinceCampaignStart <= 15) {
                validityMonths = 6;
            } else {
                validityMonths = 1;
            }

            const expiryDate = new Date(registrationDate);
            expiryDate.setMonth(expiryDate.getMonth() + validityMonths);
            
            return {
                months: validityMonths,
                expiryDate: expiryDate
            };
        }

        function generateCardId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 7);
            return `OBL-${timestamp}-${random}`.toUpperCase();
        }

        // ==================== EMAIL SENDING ====================
        
        async function sendCardEmail(cardData) {
            try {
                // Initialize EmailJS
                emailjs.init(EMAILJS_PUBLIC_KEY);
                
                const templateParams = {
                    to_name: cardData.name,
                    to_email: cardData.email,
                    card_id: cardData.id,
                    validity_date: new Date(cardData.expiryDate).toLocaleDateString('it-IT'),
                    validity_months: cardData.validityMonths
                };

                const response = await emailjs.send(
                    EMAILJS_SERVICE_ID,
                    EMAILJS_TEMPLATE_ID,
                    templateParams
                );
                
                console.log('Email sent successfully:', response);
                return true;
            } catch (error) {
                console.error('Email sending failed:', error);
                return false;
            }
        }

        // ==================== REGISTRATION FORM ====================
        
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const errorDiv = document.getElementById('formError');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generazione card...';
            errorDiv.classList.add('hidden');

            try {
                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const privacy = document.getElementById('privacy').checked;
                const marketing = document.getElementById('marketing').checked;

                if (!privacy) {
                    throw new Error('Devi accettare la privacy policy');
                }

                // Check if email already exists
                const cardsData = await storage.get('cards');
                const cards = cardsData ? JSON.parse(cardsData.value) : [];
                
                if (cards.find(card => card.email === email)) {
                    throw new Error('Questa email √® gi√† registrata. Controlla la tua casella di posta.');
                }

                const registrationDate = new Date();
                const validity = calculateValidity(registrationDate);
                const cardId = generateCardId();

                const cardData = {
                    id: cardId,
                    name: name,
                    email: email,
                    phone: phone,
                    marketing: marketing,
                    registrationDate: registrationDate.toISOString(),
                    expiryDate: validity.expiryDate.toISOString(),
                    validityMonths: validity.months,
                    used: false,
                    usageHistory: []
                };

                // Save to storage
                cards.push(cardData);
                await storage.set('cards', JSON.stringify(cards));

                // Send email (non-blocking)
                sendCardEmail(cardData).catch(err => {
                    console.warn('Email could not be sent:', err);
                });

                // Display card
                displayCard(cardData);

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'OTTIENI LA TUA CARD';
            }
        });

        // ==================== CARD DISPLAY ====================
        
        function displayCard(cardData) {
            // MOSTRA la card display con ringraziamenti integrati
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('cardDisplay').classList.remove('hidden');
            
            // Popola i dati
            document.getElementById('cardholderName').textContent = cardData.name;
            document.getElementById('cardId').textContent = `ID: ${cardData.id}`;
            
            const expiryDate = new Date(cardData.expiryDate);
            const validityText = `Valida fino al ${expiryDate.toLocaleDateString('it-IT', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            })} (${cardData.validityMonths} ${cardData.validityMonths === 1 ? 'mese' : 'mesi'})`;
            document.getElementById('cardValidity').textContent = validityText;

            // Generate QR Code with full card data encoded in URL
            document.getElementById('qrcode').innerHTML = '';
            const cardUrl = `${window.location.origin}/?code=${cardData.id}&name=${encodeURIComponent(cardData.name)}&email=${encodeURIComponent(cardData.email)}&expiry=${cardData.expiryDate}&months=${cardData.validityMonths}`;
            new QRCode(document.getElementById('qrcode'), {
                text: cardUrl,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Download automatico dopo 3 secondi
            setTimeout(() => {
                downloadCard();
            }, 3000);
        }

        async function downloadCard() {
            try {
                // Crea un canvas con la card completa
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 600;
                canvas.height = 900;
                
                // Sfondo gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#255C87');
                gradient.addColorStop(1, '#1a4d6d');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Border
                ctx.strokeStyle = '#EEA300';
                ctx.lineWidth = 6;
                ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
                
                // Testo card
                const cardholderName = document.getElementById('cardholderName').textContent;
                const cardId = document.getElementById('cardId').textContent;
                const cardValidity = document.getElementById('cardValidity').textContent;
                
                // Titolo
                ctx.fillStyle = '#EEA300';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('OBL TAPROOM', 300, 80);
                
                // Sottotitolo
                ctx.fillStyle = '#EEA300';
                ctx.font = 'bold 20px Arial';
                ctx.fillText('DIPENDENTI DUE MARI', 300, 120);
                
                // Nome
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 36px Arial';
                ctx.fillText(cardholderName, 300, 180);
                
                // Badge sconto
                ctx.fillStyle = '#EEA300';
                ctx.fillRect(200, 220, 200, 80);
                ctx.fillStyle = '#1a1a1a';
                ctx.font = 'bold 48px Arial';
                ctx.fillText('-10%', 300, 275);
                
                // QR Code
                const qrElement = document.getElementById('qrcode').querySelector('canvas');
                if (qrElement) {
                    ctx.drawImage(qrElement, 150, 340, 300, 300);
                }
                
                // Card ID e validit√†
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '18px Arial';
                ctx.fillText(cardId, 300, 680);
                ctx.font = '16px Arial';
                ctx.fillText('Valido su tutte le consumazioni', 300, 720);
                ctx.fillText(cardValidity, 300, 750);
                
                // Footer
                ctx.fillStyle = '#EEA300';
                ctx.font = 'bold 20px Arial';
                ctx.fillText('Ci vediamo in taproom! üç∫', 300, 820);
                
                // Download
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `OBL-Card-${cardholderName.replace(/\s/g, '-')}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
                
            } catch (error) {
                console.error('Errore download:', error);
            }
        }

        async function shareCard() {
            const cardId = document.getElementById('cardId').textContent.replace('ID: ', '');
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'OBL Taproom - Card Sconto',
                        text: `La mia card sconto OBL Taproom: ${cardId}`,
                    });
                } catch (error) {
                    console.log('Share cancelled');
                }
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(cardId).then(() => {
                    alert('Codice copiato negli appunti: ' + cardId);
                });
            }
        }

        // ==================== ADMIN FUNCTIONS ====================
        
        async function validateCardAdmin() {
            const scanInput = document.getElementById('adminScanInput');
            const resultDiv = document.getElementById('adminValidationResult');
            const cardId = scanInput.value.trim().toUpperCase();

            if (!cardId) {
                resultDiv.innerHTML = '<div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; color: #ef4444; padding: 15px; border-radius: 10px; margin-top: 20px;">Inserisci un codice card</div>';
                return;
            }

            try {
                const cardsData = await storage.get('cards');
                const cards = cardsData ? JSON.parse(cardsData.value) : [];
                
                const card = cards.find(c => c.id === cardId);

                if (!card) {
                    resultDiv.innerHTML = '<div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; color: #ef4444; padding: 20px; border-radius: 15px; margin-top: 20px; font-size: 1.1em;">‚ùå Card non trovata</div>';
                    scanInput.value = '';
                    return;
                }

                const now = new Date();
                const expiryDate = new Date(card.expiryDate);

                if (now > expiryDate) {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; color: #ef4444; padding: 20px; border-radius: 15px; margin-top: 20px; font-size: 1.1em;">
                            ‚ùå Card scaduta<br>
                            <small>Scaduta il ${expiryDate.toLocaleDateString('it-IT')}</small>
                        </div>
                    `;
                    scanInput.value = '';
                    return;
                }

                // Mark as used
                const usageRecord = {
                    cardId: cardId,
                    timestamp: now.toISOString(),
                    validatedBy: 'admin'
                };

                card.used = true;
                card.usageHistory.push(usageRecord);

                await storage.set('cards', JSON.stringify(cards));
                
                const usageData = await storage.get('usage');
                const usageHistory = usageData ? JSON.parse(usageData.value) : [];
                usageHistory.push(usageRecord);
                await storage.set('usage', JSON.stringify(usageHistory));

                resultDiv.innerHTML = `
                    <div style="background: rgba(52, 211, 153, 0.1); border: 2px solid #34d399; color: #34d399; padding: 20px; border-radius: 15px; margin-top: 20px; font-size: 1.1em;">
                        ‚úÖ Card Valida!<br>
                        <strong style="color: #1a1a1a;">${card.name}</strong><br>
                        <small style="color: #666;">Email: ${card.email}</small><br>
                        <small style="color: #666;">Sconto: 10% su tutto</small><br>
                        <small style="color: #666;">Utilizzi totali: ${card.usageHistory.length}</small><br>
                        <small style="color: #666;">Valida fino al ${expiryDate.toLocaleDateString('it-IT')}</small>
                    </div>
                `;

                scanInput.value = '';
                updateAdminStats();

                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 5000);

            } catch (error) {
                resultDiv.innerHTML = `<div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; color: #ef4444; padding: 20px; border-radius: 15px; margin-top: 20px;">‚ùå Errore: ${error.message}</div>`;
                console.error('Validation error:', error);
            }
        }

        async function updateAdminStats() {
            try {
                const cardsData = await storage.get('cards');
                const cards = cardsData ? JSON.parse(cardsData.value) : [];
                
                const totalCards = cards.length;
                const usedCards = cards.filter(c => c.used).length;
                const conversionRate = totalCards > 0 ? ((usedCards / totalCards) * 100).toFixed(1) : 0;
                
                const today = new Date().toDateString();
                const todayRegistrations = cards.filter(c => 
                    new Date(c.registrationDate).toDateString() === today
                ).length;

                document.getElementById('adminTotalCards').textContent = totalCards;
                document.getElementById('adminUsedCards').textContent = usedCards;
                document.getElementById('adminConversionRate').textContent = conversionRate + '%';
                document.getElementById('adminTodayRegistrations').textContent = todayRegistrations;

            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        async function downloadStatsAdmin() {
            try {
                const cardsData = await storage.get('cards');
                const cards = cardsData ? JSON.parse(cardsData.value) : [];
                
                const usageData = await storage.get('usage');
                const usage = usageData ? JSON.parse(usageData.value) : [];

                const report = {
                    generatedAt: new Date().toISOString(),
                    campaignStart: CAMPAIGN_START.toISOString(),
                    summary: {
                        totalCards: cards.length,
                        usedCards: cards.filter(c => c.used).length,
                        unusedCards: cards.filter(c => !c.used).length
                    },
                    cards: cards,
                    usage: usage
                };

                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `obl-report-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

            } catch (error) {
                alert('Errore nel download del report: ' + error.message);
            }
        }

        // ==================== GOOGLE SHEETS SYNC ====================
        
        async function syncToGoogleSheets() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Sincronizzando...';
            
            try {
                const cardsData = await storage.get('cards');
                const cards = cardsData ? JSON.parse(cardsData.value) : [];
                
                if (cards.length === 0) {
                    alert('Nessuna card da sincronizzare!');
                    btn.disabled = false;
                    btn.textContent = 'üì§ Sincronizza con Google Sheets';
                    return;
                }
                
                let synced = 0;
                for (const card of cards) {
                    try {
                        await fetch(GOOGLE_SHEETS_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'register',
                                id: card.id,
                                name: card.name,
                                email: card.email,
                                phone: card.phone || '',
                                marketing: card.marketing ? 'S√¨' : 'No',
                                registrationDate: card.registrationDate,
                                expiryDate: card.expiryDate,
                                validityMonths: card.validityMonths,
                                used: card.used ? 'S√¨' : 'No'
                            })
                        });
                        synced++;
                        await new Promise(resolve => setTimeout(resolve, 500)); // Pausa tra chiamate
                    } catch (error) {
                        console.error('Sync error for card:', card.id, error);
                    }
                }
                
                alert(`‚úÖ ${synced} card sincronizzate con Google Sheets!\n\nControlla il foglio Google.`);
                btn.textContent = '‚úÖ Sincronizzato!';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'üì§ Sincronizza con Google Sheets';
                }, 3000);
                
            } catch (error) {
                alert('‚ùå Errore durante la sincronizzazione: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üì§ Sincronizza con Google Sheets';
            }
        }

        // ==================== ADMIN ACCESS ====================
        
        function openAdmin() {
            const password = prompt('Password Admin:');
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('landingPage').classList.add('hidden');
                document.getElementById('cardDisplay').classList.add('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                updateAdminStats();
            } else {
                alert('Password errata!');
            }
        }

        // ==================== URL ROUTING ====================
        
        window.addEventListener('load', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                // QR code scansionato - leggi dati dall'URL
                const password = prompt('Password Admin:');
                
                if (password === ADMIN_PASSWORD) {
                    // Estrai dati dalla URL
                    const name = decodeURIComponent(urlParams.get('name') || '');
                    const email = decodeURIComponent(urlParams.get('email') || '');
                    const expiryDateStr = urlParams.get('expiry') || '';
                    const months = urlParams.get('months') || '';
                    
                    // Nascondi tutto, mostra solo admin
                    document.getElementById('landingPage').classList.add('hidden');
                    document.getElementById('cardDisplay').classList.add('hidden');
                    document.getElementById('adminSection').classList.remove('hidden');
                    
                    // Mostra subito le info della card
                    const now = new Date();
                    const expiryDate = new Date(expiryDateStr);
                    
                    const resultDiv = document.getElementById('adminValidationResult');
                    
                    if (now > expiryDate) {
                        resultDiv.innerHTML = `
                            <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; color: #ef4444; padding: 20px; border-radius: 15px; margin-top: 20px; font-size: 1.1em;">
                                ‚ùå Card scaduta<br>
                                <strong style="color: #1a1a1a;">${name}</strong><br>
                                <small style="color: #666;">Scaduta il ${expiryDate.toLocaleDateString('it-IT')}</small>
                            </div>
                        `;
                    } else {
                        // Card valida - traccia l'utilizzo
                        try {
                            await fetch(GOOGLE_SHEETS_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    action: 'validate',
                                    id: code,
                                    timestamp: new Date().toLocaleString('it-IT')
                                })
                            });
                        } catch (error) {
                            console.error('Tracking error:', error);
                        }
                        
                        resultDiv.innerHTML = `
                            <div style="background: rgba(52, 211, 153, 0.1); border: 2px solid #34d399; color: #34d399; padding: 20px; border-radius: 15px; margin-top: 20px; font-size: 1.1em;">
                                ‚úÖ Card Valida e Tracciata!<br>
                                <strong style="color: #1a1a1a;">${name}</strong><br>
                                <small style="color: #666;">Email: ${email}</small><br>
                                <small style="color: #666;">ID: ${code}</small><br>
                                <small style="color: #666;">Sconto: 10% su tutto</small><br>
                                <small style="color: #666;">Valida fino al ${expiryDate.toLocaleDateString('it-IT')}</small><br>
                                <small style="color: #666;">Durata: ${months} ${months == 1 ? 'mese' : 'mesi'}</small>
                            </div>
                        `;
                    }
                    
                    // Nascondi input e bottone validazione (non servono pi√π)
                    document.querySelector('.scan-area').style.display = 'none';
                    
                } else {
                    alert('Password errata!');
                    window.location.href = 'index.html';
                }
            }
        });

        // Enter key per validazione admin
        document.addEventListener('DOMContentLoaded', function() {
            const adminInput = document.getElementById('adminScanInput');
            if (adminInput) {
                adminInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        validateCardAdmin();
                    }
                });
            }
        });

        // Handle logo loading errors
        document.getElementById('mainLogo').onerror = function() {
            this.style.display = 'none';
            this.parentElement.innerHTML = '<div style="font-size: 48px; font-weight: bold; color: #EEA300;">OBL</div>';
        };

        document.getElementById('cardLogo').onerror = function() {
            this.style.display = 'none';
            this.parentElement.innerHTML = '<div style="font-size: 36px; font-weight: bold; color: #255C87;">OBL</div>';
        };
    </script>
	<script>
// Autoplay musica all'apertura
document.addEventListener('DOMContentLoaded', function() {
    const music = document.getElementById('backgroundMusic');
    music.volume = 0.12; // Volume 12%
    
    // Tenta autoplay immediato
    const playPromise = music.play();
    
    if (playPromise !== undefined) {
        playPromise.then(() => {
            console.log('Musica partita automaticamente');
        }).catch(() => {
            console.log('Autoplay bloccato - attendo click utente');
            // Fallback: parte al primo click/touch
            const startMusic = () => {
                music.play();
                document.removeEventListener('click', startMusic);
                document.removeEventListener('touchstart', startMusic);
            };
            document.addEventListener('click', startMusic);
            document.addEventListener('touchstart', startMusic);
        });
    }
});
</script>
</body>
</html>